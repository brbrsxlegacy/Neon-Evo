<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>NEON RISE ONLINE</title>
<style>
body { margin:0; background:#000; color:#0ff; font-family:Arial; overflow:hidden; }
canvas { display:block; }
button { padding:6px 10px; margin:4px; }
#menu {
  position:fixed; inset:0;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  background:#000; z-index:10;
}
#hud { position:fixed; top:10px; left:10px; }
</style>
</head>
<body>

<div id="menu">
  <h1>NEON RISE ONLINE</h1>
  <button onclick="createRoom()">ODA OLUŞTUR</button>
  <button onclick="joinRoom()">ODAYA GİR</button>
</div>

<div id="hud"></div>
<canvas id="game"></canvas>

<script type="module">

/* =========================
   FIREBASE INIT
========================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue, runTransaction, remove, onDisconnect } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyABqkhpL1SMRzRJ9GQLjjZE2IryqpAvMPw",
  authDomain: "pixelroom-ae218.firebaseapp.com",
  databaseURL: "https://pixelroom-ae218-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "pixelroom-ae218",
  storageBucket: "pixelroom-ae218.firebasestorage.app",
  messagingSenderId: "720297722320",
  appId: "1:720297722320:web:c815edae99d1efa7ff39d5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* =========================
   CORE GAME
========================= */

const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

const hud = document.getElementById("hud");

let currentRoom = null;
let playerId = "p_"+Math.random().toString(36).substr(2,5);
let myRef = null;
let remotePlayers = {};

let player = {
  x:0,y:0,
  level:1,
  hp:100,
  speed:3,
  clan:null
};

/* =========================
   RANK
========================= */

function getRank(lv){
  if(lv>=80) return "NEON GOD";
  if(lv>=50) return "DIAMOND";
  if(lv>=25) return "GOLD";
  if(lv>=10) return "SILVER";
  return "BRONZE";
}

/* =========================
   ROOM SYSTEM
========================= */

window.createRoom = async function(){
  const roomName = "room_"+Math.random().toString(36).substr(2,4);

  await set(ref(db,"rooms/"+roomName+"/meta"),{
    respawn:{x:0,y:0}
  });

  connectRoom(roomName);
}

window.joinRoom = async function(){
  const snap = await get(ref(db,"rooms"));
  const rooms = snap.val()||{};

  for(const r in rooms){
    const count = rooms[r].players?Object.keys(rooms[r].players).length:0;
    if(count<10){
      connectRoom(r);
      return;
    }
  }

  alert("Boş oda yok");
}

async function connectRoom(roomName){

  document.getElementById("menu").style.display="none";
  currentRoom = roomName;

  const meta = await get(ref(db,"rooms/"+roomName+"/meta"));
  const spawn = meta.val().respawn;

  player.x = spawn.x;
  player.y = spawn.y;

  myRef = ref(db,"rooms/"+roomName+"/players/"+playerId);

  await set(myRef,{
    x:player.x,
    y:player.y,
    level:player.level,
    hp:player.hp
  });

  onDisconnect(myRef).remove();

  onValue(ref(db,"rooms/"+roomName+"/players"),snap=>{
    const data = snap.val()||{};
    remotePlayers={};
    for(const id in data){
      if(id!==playerId){
        remotePlayers[id]=data[id];
      }
    }
  });

  setInterval(syncPlayer,100);
}

/* =========================
   SYNC
========================= */

function syncPlayer(){
  if(!currentRoom) return;
  set(myRef,{
    x:player.x,
    y:player.y,
    level:player.level,
    hp:player.hp
  });
}

/* =========================
   INPUT
========================= */

let keys={};
onkeydown=e=>keys[e.key]=true;
onkeyup=e=>keys[e.key]=false;

/* =========================
   UPDATE
========================= */

function update(){

  if(keys["w"]) player.y-=player.speed;
  if(keys["s"]) player.y+=player.speed;
  if(keys["a"]) player.x-=player.speed;
  if(keys["d"]) player.x+=player.speed;

  // PvP steal
  for(const id in remotePlayers){
    const p=remotePlayers[id];
    const dist=Math.hypot(player.x-p.x,player.y-p.y);
    if(dist<30 && keys[" "]){
      stealLevel(id);
    }
  }

  hud.innerHTML="Level: "+player.level+
                " | Rank: "+getRank(player.level);
}

function stealLevel(targetId){

  const targetRef=ref(db,"rooms/"+currentRoom+"/players/"+targetId);

  runTransaction(targetRef,data=>{
    if(!data) return;
    if(data.level>1){
      player.level+=data.level;
      data.level=1;
    }
    return data;
  });
}

/* =========================
   DRAW
========================= */

function draw(){

  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle="#0ff";
  ctx.beginPath();
  ctx.arc(canvas.width/2,canvas.height/2,15,0,Math.PI*2);
  ctx.fill();

  for(const id in remotePlayers){
    const p=remotePlayers[id];
    ctx.fillStyle="#f0f";
    ctx.beginPath();
    ctx.arc(
      canvas.width/2+(p.x-player.x),
      canvas.height/2+(p.y-player.y),
      15,0,Math.PI*2);
    ctx.fill();
  }
}

/* =========================
   LOOP
========================= */

function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();

</script>
</body>
</html>

