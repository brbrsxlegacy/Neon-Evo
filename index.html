<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>NEON RISE</title>
<link rel="icon" href="data:,">

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #05060a;
  overflow: hidden;
  touch-action: none;
  font-family: system-ui, sans-serif;
}

canvas {
  display: block;
  background: radial-gradient(circle at center, #0b1020, #02030a);
}

/* Mobil joystick */
#joystick {
  position: fixed;
  left: 20px;
  bottom: 20px;
  width: 140px;
  height: 140px;
  border-radius: 50%;
  background: rgba(0,255,255,0.08);
  border: 2px solid rgba(0,255,255,0.4);
}

#stick {
  position: absolute;
  left: 45px;
  top: 45px;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: rgba(0,255,255,0.9);
}

#mainMenu{
  position:fixed;
  inset:0;
  background:linear-gradient(#02030a,#000);
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:20px;
  z-index:10;
}

#mainMenu h1{
  font-size:48px;
  color:#00ffff;
  text-shadow:0 0 20px #00ffff;
}

#mainMenu button{
  width:220px;
  padding:14px;
  font-size:18px;
  border:none;
  background:#111;
  color:#fff;
  border:2px solid #00ffff;
  cursor:pointer;
}

#mainMenu button:hover{
  background:#00ffff;
  color:#000;
}


#settingsMenu{
  position:fixed;
  inset:0;
  background:#000;
  color:#0ff;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:16px;
  z-index:11;
}

#shopMenu{
  position:fixed;
  inset:0;
  background:#000;
  color:#0ff;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  gap:14px;
  z-index:11;
}

</style>
</head>

<body>

<div id="shopMenu" style="display:none;">
  <h2>SHOP</h2>
  <div id="shopItems"></div>
  <button onclick="closeShop()">BACK</button>
</div>

<canvas id="game"></canvas>

<div id="mainMenu">
  <h1>NEON RISE</h1>
  <button onclick="startGame()">PLAY</button>
  <button onclick="openShop()">SHOP</button>
  <button onclick="openSettings()">SETTINGS</button>
</div>

<div id="settingsMenu" style="display:none;">
  <h2>SETTINGS</h2>
  <label>
    <input type="checkbox" id="sfxToggle" checked>
    Sound Effects
  </label><br><br>
  <label>
    <input type="checkbox" id="musicToggle" checked>
    Music
  </label><br><br>
  <label>
    Volume
    <input type="range" id="volumeSlider" min="0" max="1" step="0.05" value="0.6">
  </label><br><br>
  <button onclick="closeSettings()">BACK</button>
</div>


<div id="joystick">
  <div id="stick"></div>
</div>

<script>

let firebaseApp = null;
let firebaseDB = null;

window.firebaseAppReady = false;

let gameRunning = false;
const WORLD_SPAWN = { x: 0, y: 0 };
const remotePlayers = {};

let myPlayerId = localStorage.getItem("playerName") || 
                 "p_" + Math.random().toString(36).substr(2,9);

/* =========================
   CANVAS & GAME LOOP
========================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

let lastTime = 0;
function gameLoop(time) {
  const delta = (time - lastTime) / 1000;
  lastTime = time;
  if(gameRunning){
  update(delta);
  draw();
}
  requestAnimationFrame(gameLoop);
}
requestAnimationFrame(gameLoop);

/* =========================
   INPUT SYSTEM
========================= */
const keys = {};
window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);

/* Mobil joystick */
let joyX = 0, joyY = 0;
const joystick = document.getElementById("joystick");
const stick = document.getElementById("stick");
let dragging = false;

joystick.addEventListener("touchstart", e => dragging = true);
window.addEventListener("touchend", () => {
  dragging = false;
  joyX = joyY = 0;
  stick.style.left = "45px";
  stick.style.top = "45px";
});

window.addEventListener("touchmove", e => {
  if (!dragging) return;
  const rect = joystick.getBoundingClientRect();
  const touch = e.touches[0];
  let x = touch.clientX - rect.left - 70;
  let y = touch.clientY - rect.top - 70;
  const dist = Math.hypot(x, y);
  if (dist > 40) {
    x = x / dist * 40;
    y = y / dist * 40;
  }
  joyX = x / 40;
  joyY = y / 40;
  stick.style.left = 45 + x + "px";
  stick.style.top = 45 + y + "px";
});

/* =========================
   PLAYER
========================= */
const player = {
  x: WORLD_SPAWN.x,
  y: WORLD_SPAWN.y,
  size: 18,
  speed: 260,
  slowTimer: 0
};


function update(dt) {
  let dx = 0, dy = 0;

  if (keys["w"] || keys["ArrowUp"]) dy -= 1;
  if (keys["s"] || keys["ArrowDown"]) dy += 1;
  if (keys["a"] || keys["ArrowLeft"]) dx -= 1;
  if (keys["d"] || keys["ArrowRight"]) dx += 1;

  dx += joyX;
  dy += joyY;

  const len = Math.hypot(dx, dy);
  if (len > 0) {
    dx /= len;
    dy /= len;
  }

  player.x += dx * player.speed * dt;
  player.y += dy * player.speed * dt;
}

player.dash = {
  cooldown: 0,
  cdTime: 1.2,
  power: 160,
  invulnTime: 0.25
};

player.quests = [];
  
  // slow effect
  if(player.slowTimer > 0){
    player.slowTimer -= dt;
    player.speed = 140;
  } else {
    player.speed = 260;
  }

function getBiome(x,y){
  if(x > 900) return "fire";
  if(x < -900) return "ice";
  return "forest";
}



function startGame(){
  const mm = document.getElementById("mainMenu");
  if (mm) mm.style.display = "none";
  const sm = document.getElementById("shopMenu");
  if (sm) sm.style.display = "none";
  gameRunning = true;
}

function openSettings(){
  document.getElementById("mainMenu").style.display="none";
  document.getElementById("settingsMenu").style.display="flex";
}

function closeSettings(){
  document.getElementById("settingsMenu").style.display="none";
  document.getElementById("mainMenu").style.display="flex";
}
  
function openShop(){
  const mm = document.getElementById("mainMenu");
  if (mm) mm.style.display = "none";
  const sm = document.getElementById("shopMenu");
  if (sm) sm.style.display = "flex";
  if (typeof renderShopAdvanced === "function") renderShopAdvanced();
  else if (typeof renderShop === "function") renderShop();
}

function closeShop(){
  const sm = document.getElementById("shopMenu");
  if (sm) sm.style.display = "none";
  const mm = document.getElementById("mainMenu");
  if (mm) mm.style.display = "flex";
}

/* =========================
   DRAW
========================= */
function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.save();
  ctx.translate(canvas.width/2 - player.x, canvas.height/2 - player.y);
  const biome = getBiome(player.x, player.y);
  // WORLD BACKGROUND (biyoma g√∂re renk)
  let bg;
  
  if (biome === "fire") {
    bg = ctx.createRadialGradient(0,0,200,0,0,1600);
    bg.addColorStop(0,"#2a1208");
    bg.addColorStop(1,"#090201");
  }
  else if (biome === "ice") {
    bg = ctx.createRadialGradient(0,0,200,0,0,1600);
    bg.addColorStop(0,"#0b1e2f");
    bg.addColorStop(1,"#02060c");
  }
  else {
    bg = ctx.createRadialGradient(0,0,200,0,0,1600);
    bg.addColorStop(0,"#071a14");
    bg.addColorStop(1,"#010403");
  }
  
  ctx.fillStyle = bg;
 ctx.fillRect(player.x-1200, player.y-1200, 2400, 2400);

  
  ctx.strokeStyle = biome === "fire" ? "#ff330055" :
                  biome === "ice" ? "#66ccff55" :
                  "#00ffaa33";
  ctx.lineWidth = 1;

  // Grid
  const gridSize = 60;
  const startX = Math.floor((player.x - canvas.width/2) / gridSize) * gridSize;
  const startY = Math.floor((player.y - canvas.height/2) / gridSize) * gridSize;
  
  for (let x = startX; x < startX + canvas.width + gridSize; x += gridSize) {
    ctx.beginPath();
    ctx.moveTo(x, startY);
    ctx.lineTo(x, startY + canvas.height + gridSize);
    ctx.stroke();
  }
  
  for (let y = startY; y < startY + canvas.height + gridSize; y += gridSize) {
    ctx.beginPath();
    ctx.moveTo(startX, y);
    ctx.lineTo(startX + canvas.width + gridSize, y);
    ctx.stroke();
}


  // Player glow
  ctx.shadowBlur = 25;
  ctx.shadowColor = "#00ffff";
  ctx.fillStyle = "#00ffff";
  ctx.beginPath();
  ctx.arc(player.x, player.y, player.size, 0, Math.PI*2);
  ctx.fill();

  ctx.restore();
}

/* =========================
   ENEMY SYSTEM
========================= */

// Enemy listesi
const enemies = [];

// Enemy t√ºrleri
const ENEMY_TYPES = {
  MELEE: "melee",
  RANGED: "ranged",
  FIRE: "fire",
  ICE: "ice",
  BOSS: "boss"
};



// Enemy olu≈üturucu
function spawnEnemy() {

  const biome = getBiome(player.x, player.y);
  let type;

  if (biome === "fire") type = ENEMY_TYPES.FIRE;
  else if (biome === "ice") type = ENEMY_TYPES.ICE;
  else type = Math.random() < 0.5 ? ENEMY_TYPES.MELEE : ENEMY_TYPES.RANGED;

  const angle = Math.random() * Math.PI * 2;
  const dist = 600 + Math.random() * 400;

  enemies.push({
    type,
    x: player.x + Math.cos(angle) * dist,
    y: player.y + Math.sin(angle) * dist,
    size: 16,
    speed: 120,
    cooldown: 0
  });
}

// Spawn aralƒ±ƒüƒ±
let enemySpawnTimer = 0;

// Update i√ßine ENTEGRE
const _oldUpdate = update;
update = function(dt) {
  _oldUpdate(dt);

  enemySpawnTimer -= dt;
  if (enemySpawnTimer <= 0) {
    spawnEnemy();
    enemySpawnTimer = 1.5;
  }

  enemies.forEach(e => {
    const dx = player.x - e.x;
    const dy = player.y - e.y;
    const dist = Math.hypot(dx, dy) || 1;
    // FIRE ENEMY
    if(e.type === ENEMY_TYPES.FIRE){
      e.cooldown -= dt;
      if(e.cooldown <= 0){
        spawnParticles(e.x, e.y, "#ff5500", 6);
        player.health -= 3;
        e.cooldown = 2;
      }
    }
    
    // ICE ENEMY
    if(e.type === ENEMY_TYPES.ICE){
      const d = Math.hypot(player.x-e.x, player.y-e.y);
      if(d < 120){
        player.slowTimer = 0.5;
        spawnParticles(player.x, player.y, "#66ccff", 2);
      }
    }

    if (e.type === ENEMY_TYPES.MELEE) {
      // Yakƒ±n d√∂v√º≈ü: direkt takip
      e.x += (dx / dist) * e.speed * dt;
      e.y += (dy / dist) * e.speed * dt;
    } else {
      // Uzak menzil: mesafe korur
      if (dist > 220) {
        e.x += (dx / dist) * e.speed * dt;
        e.y += (dy / dist) * e.speed * dt;
      }
    }
  });
};


// Draw i√ßine ENTEGRE
const _oldDraw = draw;
draw = function() {
  _oldDraw();

  ctx.save();
  ctx.translate(canvas.width/2 - player.x, canvas.height/2 - player.y);

  enemies.forEach(e => {
    ctx.shadowBlur = 20;
    ctx.shadowColor = e.type === ENEMY_TYPES.MELEE ? "#ff3355" : "#ffaa00";
    if(e.type === ENEMY_TYPES.FIRE) ctx.fillStyle="#ff5500";
    else if(e.type === ENEMY_TYPES.ICE) ctx.fillStyle="#66ccff";
    else if(e.type === ENEMY_TYPES.MELEE) ctx.fillStyle="#ff3355";
    else ctx.fillStyle="#ffaa00";


    ctx.beginPath();
    ctx.arc(e.x, e.y, e.size, 0, Math.PI * 2);
    ctx.fill();
  });

  ctx.restore();
};

/* =========================
   HEALTH & COLLISION SYSTEM
========================= */

// Oyuncu can sistemi
player.maxHealth = 100;
player.health = 100;
player.invuln = 0; // hasar sonrasƒ± kƒ±sa dokunulmazlƒ±k

// Basit √ßarpƒ±≈üma kontrol√º (daire-daire)
function circleHit(ax, ay, ar, bx, by, br) {
  const dx = ax - bx;
  const dy = ay - by;
  return Math.hypot(dx, dy) < ar + br;
}

// Update'e entegre
const _update2 = update;
update = function(dt) {
  _update2(dt);

  // Dokunulmazlƒ±k s√ºresi
  if (player.invuln > 0) player.invuln -= dt;

  // D√º≈üman-oyuncu √ßarpƒ±≈ümasƒ±
  enemies.forEach(e => {
    if (circleHit(player.x, player.y, player.size, e.x, e.y, e.size)) {
      if (player.invuln <= 0) {
        player.health -= e.type === ENEMY_TYPES.MELEE ? 10 : 6;
        player.invuln = 0.6;
        

        // k√º√ß√ºk geri itme
        const dx = player.x - e.x;
        const dy = player.y - e.y;
        const d = Math.hypot(dx, dy) || 1;
        player.x += (dx / d) * 18;
        player.y += (dy / d) * 18;

        // √ñl√ºm kontrol√º
        if (player.health <= 0) {
          player.health = player.maxHealth;
          player.x = WORLD_SPAWN.x;
          player.y = WORLD_SPAWN.y;
          enemies.length = 0; // sahneyi temizle
        }
      }
    }
  });
};


// Draw'e HUD ekle
const _draw2 = draw;
draw = function() {
  _draw2();

  // HUD (ekran sabit)
  const pad = 16;
  const w = 220, h = 14;
  const ratio = Math.max(0, player.health / player.maxHealth);

  ctx.save();
  ctx.globalAlpha = 0.9;
  ctx.fillStyle = "rgba(255,255,255,0.15)";
  ctx.fillRect(pad, pad, w, h);

  ctx.shadowBlur = 10;
  ctx.shadowColor = "#00ff99";
  ctx.fillStyle = "#00ff99";
  ctx.fillRect(pad, pad, w * ratio, h);
  ctx.restore();
};
/* =========================
   XP & LEVEL SYSTEM
========================= */

// Oyuncu seviye verileri
player.level = 1;
player.xp = 0;
player.xpToNext = 100;

// Aura (ge√ßici otomatik hasar)
player.auraRadius = 34;
player.auraDps = 30; // saniyede hasar

// D√º≈ümanlara can ekle (mevcut olanlara da uygula)
function initEnemyHealth(e) {
  if (e.maxHealth == null) {
    e.maxHealth = e.type === ENEMY_TYPES.MELEE ? 40 : 30;
    e.health = e.maxHealth;
  }
}

// Level atlama
function levelUp() {
  player.level++;
  player.xp = 0;
  player.xpToNext = Math.floor(player.xpToNext * 1.35);

  // k√º√ß√ºk g√º√ßlenme
  player.speed += 20;
  player.maxHealth += 10;
  player.health = player.maxHealth;

  // aura biraz b√ºy√ºr
  player.auraRadius += 3;
  player.auraDps += 5;

  // g√∂rsel minik patlama
  screenShake.time = 0.25;
}

// Screen shake altyapƒ±sƒ± (hafif)
const screenShake = { time: 0, strength: 6 };

// Update‚Äôe entegre
const _update3 = update;
update = function(dt) {
  _update3(dt);

  // Screen shake s√ºresi
  if (screenShake.time > 0) screenShake.time -= dt;

  // D√º≈ümanlara aura hasarƒ±
  for (let i = enemies.length - 1; i >= 0; i--) {
    const e = enemies[i];
    initEnemyHealth(e);

    const dx = player.x - e.x;
    const dy = player.y - e.y;
    const dist = Math.hypot(dx, dy);

    if (dist < player.auraRadius) {
      e.health -= player.auraDps * dt;

      if (e.health <= 0) {
        // XP kazan
       player.xp += 
        e.type === ENEMY_TYPES.MELEE ? 20 :
        e.type === ENEMY_TYPES.RANGED ? 15 :
        120; // boss xp  
        enemies.splice(i, 1);

        // k√º√ß√ºk sarsƒ±ntƒ±
        screenShake.time = 0.12;

        if (player.xp >= player.xpToNext) {
          levelUp();
        }
      }
    }
  }
};

// Draw‚Äôe XP HUD + aura g√∂rseli
const _draw3 = draw;
draw = function() {
  // screen shake uygula
  let sx = 0, sy = 0;
  if (screenShake.time > 0) {
    sx = (Math.random() - 0.5) * screenShake.strength;
    sy = (Math.random() - 0.5) * screenShake.strength;
  }
  ctx.save();
  ctx.translate(sx, sy);
  _draw3();
  ctx.restore();

  // Aura g√∂rseli
  ctx.save();
  ctx.translate(canvas.width/2, canvas.height/2);
  ctx.globalAlpha = 0.15;
  ctx.strokeStyle = "#00ffff";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.arc(0, 0, player.auraRadius, 0, Math.PI * 2);
  ctx.stroke();
  ctx.restore();

  // XP bar
  const pad = 16;
  const w = 220, h = 10;
  const ratio = Math.min(1, player.xp / player.xpToNext);

  ctx.save();
  ctx.globalAlpha = 0.9;
  ctx.fillStyle = "rgba(255,255,255,0.15)";
  ctx.fillRect(pad, pad + 22, w, h);

  ctx.shadowBlur = 10;
  ctx.shadowColor = "#6cf";
  ctx.fillStyle = "#6cf";
  ctx.fillRect(pad, pad + 22, w * ratio, h);

  // Level yazƒ±sƒ±
  ctx.fillStyle = "#eaf2ff";
  ctx.font = "12px system-ui";
  ctx.fillText("LV " + player.level, pad + w + 10, pad + 32);
  ctx.restore();
};
/* =========================
   DRAW PIPELINE FIX
   (BLACK SCREEN HOTFIX)
========================= */

// Draw zincirini g√ºvenli hale al
let __safeDraw = draw;

draw = function () {
  ctx.setTransform(1, 0, 0, 1, 0, 0); // reset transform
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // screen shake varsa uygula
  let sx = 0, sy = 0;
  if (typeof screenShake !== "undefined" && screenShake.time > 0) {
    sx = (Math.random() - 0.5) * screenShake.strength;
    sy = (Math.random() - 0.5) * screenShake.strength;
  }

  ctx.save();
  ctx.translate(sx, sy);
  __safeDraw();
  ctx.restore();
};
/* =========================
   ATTACK SYSTEM (MELEE + RANGED)
========================= */

// ---- INPUT (klavye + mobil) ----
const attackInput = {
  melee: false,
  ranged: false
};

// Klavye
window.addEventListener("keydown", e => {
  if (e.code === "Space") attackInput.melee = true;
  if (e.key === "f" || e.key === "F") attackInput.ranged = true;
});
window.addEventListener("keyup", e => {
  if (e.code === "Space") attackInput.melee = false;
  if (e.key === "f" || e.key === "F") attackInput.ranged = false;
});

// Mobil butonlar
const btnWrap = document.createElement("div");
btnWrap.style.cssText = `
  position:fixed; right:20px; bottom:20px; display:flex; gap:12px; z-index:9;
`;
document.body.appendChild(btnWrap);

function mkBtn(txt){
  const b = document.createElement("button");
  b.textContent = txt;
  b.style.cssText = `
    width:64px;height:64px;border-radius:50%;
    background:rgba(0,255,255,.15); color:#eaf2ff;
    border:2px solid rgba(0,255,255,.6); font-size:12px;
  `;
  btnWrap.appendChild(b);
  return b;
}
const meleeBtn = mkBtn("MELEE");
const rangedBtn = mkBtn("SHOT");
const dashBtn = mkBtn("DASH");


meleeBtn.addEventListener("touchstart", ()=>attackInput.melee=true);
meleeBtn.addEventListener("touchend", ()=>attackInput.melee=false);
rangedBtn.addEventListener("touchstart", ()=>attackInput.ranged=true);
rangedBtn.addEventListener("touchend", ()=>attackInput.ranged=false);
dashBtn.addEventListener("touchstart", ()=>attackInput.dash=true);
dashBtn.addEventListener("touchend", ()=>attackInput.dash=false);

// ---- MELEE ----
player.melee = {
  range: 42,
  damage: 18,
  cooldown: 0,
  cdTime: 0.35
};

// ---- PROJECTILES ----
const bullets = [];
player.ranged = {
  speed: 520,
  damage: 14,
  cooldown: 0,
  cdTime: 0.25
};

function shootBullet(){
  // hedef: en yakƒ±n d√º≈üman y√∂n√º, yoksa ileri
  let tx = 1, ty = 0, best = Infinity;
  enemies.forEach(e=>{
    const dx = e.x - player.x;
    const dy = e.y - player.y;
    const d = Math.hypot(dx,dy);
    if (d < best){ best = d; tx = dx/d; ty = dy/d; }
  });
  bullets.push({
    x: player.x, y: player.y,
    vx: tx * player.ranged.speed,
    vy: ty * player.ranged.speed,
    r: 4
  });
}

function performDash(){

  if(player.dash.cooldown > 0) return;

  let dx = joyX;
  let dy = joyY;

  if(dx === 0 && dy === 0){
    dx = 1; // y√∂n yoksa ileri
  }

  const len = Math.hypot(dx,dy) || 1;
  dx /= len;
  dy /= len;

  player.x += dx * player.dash.power;
  player.y += dy * player.dash.power;

  player.invuln = player.dash.invulnTime;
  player.dash.cooldown = player.dash.cdTime;

  spawnParticles(player.x, player.y, player._evoColor || "#0ff", 12);
  screenShake.time = 0.15;
}

// ---- UPDATE ENTEGRASYONU ----
const _update4 = update;
update = function(dt){
  _update4(dt);

  // cooldownlar
  if (player.melee.cooldown > 0) player.melee.cooldown -= dt;
  if (player.ranged.cooldown > 0) player.ranged.cooldown -= dt;

  // MELEE saldƒ±rƒ±
  if (attackInput.melee && player.melee.cooldown <= 0){
    player.melee.cooldown = player.melee.cdTime;
    enemies.forEach(e=>{
      initEnemyHealth(e);
      const d = Math.hypot(e.x - player.x, e.y - player.y);
      if (d <= player.melee.range){
        e.health -= player.melee.damage;
        screenShake.time = 0.1;
      }
    });
  }

  // RANGED saldƒ±rƒ±
  if (attackInput.ranged && player.ranged.cooldown <= 0){
    player.ranged.cooldown = player.ranged.cdTime;
    shootBullet();
  }

  // Bullet update + √ßarpƒ±≈üma
  for (let i = bullets.length-1; i>=0; i--){
    const b = bullets[i];
    b.x += b.vx * dt;
    b.y += b.vy * dt;

    // menzil dƒ±≈üƒ±
    if (Math.hypot(b.x-player.x, b.y-player.y) > 900){
      bullets.splice(i,1); continue;
    }

    // d√º≈üman √ßarpƒ±≈ümasƒ±
    for (let j = enemies.length-1; j>=0; j--){
      const e = enemies[j];
      initEnemyHealth(e);
      if (circleHit(b.x,b.y,b.r, e.x,e.y,e.size)){
        e.health -= player.ranged.damage;
        bullets.splice(i,1);
        screenShake.time = 0.08;
        if (e.health <= 0){
          player.xp += e.type === ENEMY_TYPES.MELEE ? 20 : 15;
          enemies.splice(j,1);
          if (player.xp >= player.xpToNext) levelUp();
        }
        break;
      }
    }
  }
};

attackInput.dash = false;

window.addEventListener("keydown", e => {
  if (e.key === "Shift") attackInput.dash = true;
});
window.addEventListener("keyup", e => {
  if (e.key === "Shift") attackInput.dash = false;
});

// ---- DRAW ENTEGRASYONU ----
const _draw4 = draw;
draw = function(){
  _draw4();

  ctx.save();
  ctx.translate(canvas.width/2 - player.x, canvas.height/2 - player.y);

  // melee alanƒ±
  if (player.melee.cooldown > player.melee.cdTime - 0.08){
    ctx.globalAlpha = 0.2;
    ctx.strokeStyle = "#00ffff";
    ctx.beginPath();
    ctx.arc(player.x, player.y, player.melee.range, 0, Math.PI*2);
    ctx.stroke();
  }

  // mermiler
  ctx.globalAlpha = 1;
  ctx.fillStyle = "#6cf";
  bullets.forEach(b=>{
    ctx.beginPath();
    ctx.arc(b.x,b.y,b.r,0,Math.PI*2);
    ctx.fill();
  });

  ctx.restore();
};
/* =========================
   VISUAL EFFECTS & POLISH
========================= */

// ---- PARTICLES ----
const particles = [];

function spawnParticles(x, y, color="#00ffff", count=10){
  for (let i=0;i<count;i++){
    particles.push({
      x, y,
      vx: (Math.random()-0.5)*260,
      vy: (Math.random()-0.5)*260,
      life: 0.4 + Math.random()*0.3,
      r: 2 + Math.random()*2,
      color
    });
  }
}

// ---- HIT FLASH ----
function hitFlash(e){
  e._flash = 0.1;
}

// ---- UPDATE ENTEGRASYONU ----
const _update5 = update;
update = function(dt){
  _update5(dt);

  // Particle update
  for (let i = particles.length-1; i>=0; i--){
    const p = particles[i];
    p.life -= dt;
    p.x += p.vx * dt;
    p.y += p.vy * dt;
    p.vx *= 0.96;
    p.vy *= 0.96;
    if (p.life <= 0) particles.splice(i,1);
  }

  // Enemy flash timer
  enemies.forEach(e=>{
    if (e._flash > 0) e._flash -= dt;
  });
};

// ---- D√ú≈ûMAN √ñL√úM√úNE PARTƒ∞K√úL BAƒûLA ----
const _killXP = levelUp;
levelUp = function(){
  spawnParticles(player.x, player.y, "#6cf", 18);
  _killXP();
};

// Mermi ve melee vuru≈ülarƒ±nda efekt
const _shootBulletFx = shootBullet;
shootBullet = function(){
  _shootBulletFx();
  spawnParticles(player.x, player.y, "#6cf", 6);
};

// ---- DRAW ENTEGRASYONU ----
const _draw5 = draw;
draw = function(){
  _draw5();

  ctx.save();
  ctx.translate(canvas.width/2 - player.x, canvas.height/2 - player.y);

  // Particles
  particles.forEach(p=>{
    ctx.globalAlpha = Math.max(0, p.life);
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    ctx.fill();
  });

  ctx.restore();
};
/* =========================
   CHARACTER EVOLUTION
========================= */

// Evrim a≈üamalarƒ±
const EVOLUTIONS = [
  { lvl: 1,  size: 18, glow: 18, color: "#00ffff", auraMul: 1.0 },
  { lvl: 4,  size: 20, glow: 22, color: "#6cf",    auraMul: 1.1 },
  { lvl: 8,  size: 22, glow: 26, color: "#9f6cff", auraMul: 1.2 },
  { lvl: 12, size: 24, glow: 30, color: "#ff6cf0", auraMul: 1.35 }
];

player.evoIndex = 0;

// Evrimi uygula
function applyEvolution() {
  let idx = 0;
  for (let i = 0; i < EVOLUTIONS.length; i++) {
    if (player.level >= EVOLUTIONS[i].lvl) idx = i;
  }
  if (idx !== player.evoIndex) {
    player.evoIndex = idx;
    const e = EVOLUTIONS[idx];

    player.size = e.size;
    player._evoColor = e.color;
    player._evoGlow = e.glow;

    // Aura g√º√ßlendirme
    player.auraRadius = Math.floor(player.auraRadius * e.auraMul);

    // G√∂rsel geri bildirim
    spawnParticles(player.x, player.y, e.color, 28);
    screenShake.time = 0.2;
  }
}

// LevelUp‚Äôa baƒüla
const _levelUpEvo = levelUp;
levelUp = function () {
  _levelUpEvo();
  applyEvolution();
};

// Oyun ba≈üƒ±nda da uygula
applyEvolution();

// ---- DRAW EVOLUTION ----
const _draw6 = draw;
draw = function () {
  _draw6();

  ctx.save();
  ctx.translate(canvas.width / 2 - player.x, canvas.height / 2 - player.y);

  // Player glow + core
  ctx.shadowBlur = player._evoGlow || 18;
  ctx.shadowColor = player._evoColor || "#00ffff";
  ctx.fillStyle = player._evoColor || "#00ffff";

  ctx.beginPath();
  ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
  ctx.fill();
  // Equipped skin efekti
if (player.equippedSkin) {
  ctx.lineWidth = 4;
  ctx.strokeStyle = "#fff";
  ctx.shadowBlur = 15;
  ctx.shadowColor = "#fff";
  ctx.stroke();
}

  ctx.restore();
};
/* =========================
   EVOLUTION 0‚Äì100 + COSMETICS + SHOP
========================= */

/* ---- EVOLUTION DATA (0‚Äì100) ---- */
player.appearance = {
  color: "#00ffff",
  glow: 18,
  outfit: "none"
};

function getEvolutionByLevel(lv){
  return {
    size: 18 + Math.floor(lv / 5),              // her 5 level b√ºy√ºr
    glow: 18 + Math.floor(lv / 4),
    color: `hsl(${(lv*3)%360}, 80%, 60%)`        // levela g√∂re renk
  };
}

/* ---- MARKET DATA ---- */
player.coins = 0;
const SHOP_ITEMS = [
  { id:"hoodie", name:"Neon Hoodie", price:150 },
  { id:"jacket", name:"Cyber Jacket", price:300 },
  { id:"aura+",  name:"Aura Booster", price:200 }
];

/* ---- XP'DEN COIN ---- */
const _xpCoin = levelUp;
levelUp = function(){
  _xpCoin();
  player.coins += 25;
};

/* ---- SHOP UI ---- */
const shopBtn = document.createElement("button");
shopBtn.textContent = "SHOP";
shopBtn.style.cssText = `
  position:fixed;
  bottom:90px;
  right:20px;
  background:#0ff2;
  color:#fff;
  border:1px solid #0ff;
  padding:6px 10px;
  z-index:9;
`;
document.body.appendChild(shopBtn);

const shopPanel = document.createElement("div");
shopPanel.style.cssText = `
  position:fixed; inset:20%;
  background:#02030a;
  border:2px solid #0ff;
  color:#eaf2ff;
  padding:12px;
  display:none;
`;
document.body.appendChild(shopPanel);

shopBtn.onclick = ()=>{
  shopPanel.style.display = shopPanel.style.display==="none"?"block":"none";
  renderShop();
};

function renderShop(){
  shopPanel.innerHTML = `<b>COINS:</b> ${player.coins}<hr>`;
  SHOP_ITEMS.forEach(it=>{
    const b = document.createElement("button");
    b.textContent = `${it.name} (${it.price})`;
    b.style.display="block";
    b.onclick = ()=>{
      if (player.coins >= it.price){
        player.coins -= it.price;
        if (it.id==="aura+") player.auraRadius += 6;
        else player.appearance.outfit = it.id;
        renderShop();
      }
    };
    shopPanel.appendChild(b);
  });
}
/* =========================
   ADMIN + CREATOR + ADVANCED SHOP
========================= */

/* ---- ADMIN ---- */
const ADMIN_CODE = "sus304";
player.isAdmin = false;

// Coini u√ßur üòà
if (player.isAdmin) player.coins = 10000000000;

/* ---- SHOP ITEMS (50 ADET) ---- */
const SHOP_ITEMS_ADV = [];
for (let i = 1; i <= 50; i++) {
  SHOP_ITEMS_ADV.push({
    id: "item" + i,
    name: "Neon Item " + i,
    price: i * 100,
    color: `hsl(${i * 7 % 360},80%,60%)`,
    type: i % 5 === 0 ? "aura" : "outfit"
  });
}

/* ---- SHOP UI G√úNCELLE ---- */
shopPanel.style.inset = "10%";
shopPanel.style.overflow = "auto";

/* ---- ADMIN + CREATOR PANEL ---- */
const adminBtn = document.createElement("button");
adminBtn.textContent = "ADMIN / CREATOR";
adminBtn.style.cssText = `
  position:fixed; top:52px; right:12px;
  background:#ff00552a; color:#fff;
  border:1px solid #ff3355;
  padding:6px 10px;
`;
document.body.appendChild(adminBtn);

const adminPanel = document.createElement("div");
adminPanel.style.cssText = `
  position:fixed; inset:15%;
  background:#02030a;
  border:2px solid #ff3355;
  color:#fff;
  padding:12px;
  display:none;
`;
document.body.appendChild(adminPanel);

adminBtn.onclick = () => {
  adminPanel.style.display = adminPanel.style.display === "none" ? "block" : "none";
  renderAdmin();
};

function renderAdmin() {
  adminPanel.innerHTML = `
    <h3>ADMIN / CREATOR PANEL</h3>
    <input id="adminCode" placeholder="Admin Code">
    <button id="enterAdmin">Gƒ∞R</button>
    <hr>
    <div id="creatorArea" style="display:${player.isAdmin ? "block":"none"}">
      <h4>ƒ∞√ßerik √úretici Alanƒ±</h4>
      <input id="newItemName" placeholder="√úr√ºn adƒ±">
      <input id="newItemColor" placeholder="Renk (red / #fff / hsl)">
      <input id="newItemPrice" placeholder="Fiyat">
      <button id="addItem">√úr√ºn Ekle</button>
    </div>
  `;

  document.getElementById("enterAdmin").onclick = () => {
    const code = document.getElementById("adminCode").value;
    if (code === ADMIN_CODE) {
      player.isAdmin = true;
      alert("ADMIN AKTƒ∞F üî•");
      renderAdmin();
    }
  };

  if (player.isAdmin) {
    document.getElementById("addItem").onclick = () => {
      SHOP_ITEMS_ADV.push({
        id: "custom" + Date.now(),
        name: document.getElementById("newItemName").value || "Custom",
        price: parseInt(document.getElementById("newItemPrice").value) || 0,
        color: document.getElementById("newItemColor").value || "#0ff",
        type: "outfit"
      });
      alert("√úr√ºn eklendi");
      renderShopAdvanced();
    };
  }
}

/* ---- ADVANCED SHOP RENDER ---- */
function renderShopAdvanced() {
  shopPanel.innerHTML = `<b>COINS:</b> ${player.coins}<hr>`;
  shopPanel.style.display = "grid";
  shopPanel.style.gridTemplateColumns = "repeat(auto-fill, minmax(120px,1fr))";
  shopPanel.style.gap = "10px";

  SHOP_ITEMS_ADV.forEach(it => {
    const card = document.createElement("div");
    card.style.cssText = `
      border:1px solid ${it.color};
      padding:8px;
      text-align:center;
      cursor:pointer;
      background:#000;
    `;
    card.innerHTML = `
      <div style="
        width:60px;height:60px;
        margin:0 auto 6px;
        background:${it.color};
        border-radius:50%;
        box-shadow:0 0 12px ${it.color};
      "></div>
      <div>${it.name}</div>
      <small>${it.price}</small>
    `;
    card.onclick = () => {
     if (player.coins >= it.price) {
  player.coins -= it.price;

  if (it.type === "aura") {
    player.auraRadius += 4;
  } else {
    // inventory Set olduƒüu i√ßin duplicate olmaz
   player.inventory.push(it.id);
  }

  renderShopAdvanced();
}

    };
    shopPanel.appendChild(card);
  });
}

/* ---- SHOP BUTTON OVERRIDE ---- */
shopBtn.onclick = () => {
  shopPanel.style.display = shopPanel.style.display === "none" ? "grid" : "none";
  renderShopAdvanced();
};
/* =========================
   SHOP CLOSE (X BUTTON)
========================= */

// X butonu olu≈ütur (tek sefer)
const shopCloseBtn = document.createElement("div");
shopCloseBtn.textContent = "‚úï";
shopCloseBtn.style.cssText = `
  position:fixed;
  top:14px; right:14px;
  width:32px; height:32px;
  display:flex; align-items:center; justify-content:center;
  background:#000;
  color:#fff;
  border:1px solid #0ff;
  border-radius:6px;
  cursor:pointer;
  z-index:9999;
  box-shadow:0 0 10px #0ff;
`;
shopCloseBtn.style.display = "none";
document.body.appendChild(shopCloseBtn);

// X tƒ±klanƒ±nca marketi kapat
shopCloseBtn.onclick = () => {
  shopPanel.style.display = "none";
  shopCloseBtn.style.display = "none";
};

// Market a√ßƒ±ldƒ±ƒüƒ±nda X'i g√∂ster
const _shopBtnClick = shopBtn.onclick;
shopBtn.onclick = () => {
  _shopBtnClick();
  const open = shopPanel.style.display !== "none";
  shopCloseBtn.style.display = open ? "flex" : "none";
};

// Admin/Creator paneli a√ßƒ±lƒ±rsa X gizle (karƒ±≈ümasƒ±n)
const _adminBtnClick = adminBtn.onclick;
adminBtn.onclick = () => {
  _adminBtnClick();
  shopCloseBtn.style.display = "none";
};
/* =========================
   SAVE / LOAD (localStorage)
========================= */

const SAVE_KEY = "NEON_RISE_SAVE_V1";

// Kaydedilecek veriyi hazƒ±rla
function buildSaveData() {
  return {
    player: {
      x: player.x,
      y: player.y,
      level: player.level,
      xp: player.xp,
      xpToNext: player.xpToNext,
      maxHealth: player.maxHealth,
      health: player.health,
      speed: player.speed,
      auraRadius: player.auraRadius,
      coins: player.coins,
      appearance: player.appearance,
      isAdmin: player.isAdmin
    },
    shop: {
      items: SHOP_ITEMS_ADV // admin ekledikleri dahil
    },
    time: Date.now()
  };
}

// Kaydet
function saveGame() {
  try {
    const data = buildSaveData();
    localStorage.setItem(SAVE_KEY, JSON.stringify(data));
    toast("Kaydedildi üíæ");
  } catch (e) {
    console.error(e);
  }
}

// Y√ºkle
function loadGame() {
  const raw = localStorage.getItem(SAVE_KEY);
  if (!raw) return;
  try {
    const data = JSON.parse(raw);

    Object.assign(player, data.player);
    if (data.shop && data.shop.items) {
      SHOP_ITEMS_ADV.length = 0;
      data.shop.items.forEach(it => SHOP_ITEMS_ADV.push(it));
    }
    applyEvolution(); // evrimi yeniden uygula
    toast("Y√ºklendi ‚úÖ");
  } catch (e) {
    console.error(e);
  }
}

// Otomatik y√ºkle
window.addEventListener("load", loadGame);

  
// Otomatik kaydet (30 sn)
setInterval(saveGame, 30000);

// Sekme kapanƒ±rken kaydet
window.addEventListener("beforeunload", saveGame);

// ---- Basit Toast Bildirimi ----
const toastEl = document.createElement("div");
toastEl.style.cssText = `
  position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
  background:#000; color:#0ff; padding:8px 14px;
  border:1px solid #0ff; border-radius:8px;
  box-shadow:0 0 12px #0ff; z-index:9999;
  opacity:0; transition:opacity .2s;
`;
document.body.appendChild(toastEl);

function toast(msg){
  if(typeof toastEl === "undefined") return;
  toastEl.textContent = msg;
  toastEl.style.opacity = 1;
  setTimeout(()=> toastEl.style.opacity = 0, 1200);
}

// ---- Manuel Kaydet/Y√ºkle Butonlarƒ± ----
const saveBtn = document.createElement("button");
saveBtn.textContent = "SAVE";
saveBtn.style.cssText = `
  position:fixed; left:12px; bottom:12px;
  background:#0ff2; color:#eaf2ff;
  border:1px solid #0ff; padding:6px 10px;
`;
document.body.appendChild(saveBtn);
saveBtn.onclick = saveGame;

const loadBtn = document.createElement("button");
loadBtn.textContent = "LOAD";
loadBtn.style.cssText = `
  position:fixed; left:72px; bottom:12px;
  background:#0ff2; color:#eaf2ff;
  border:1px solid #0ff; padding:6px 10px;
`;
document.body.appendChild(loadBtn);
loadBtn.onclick = loadGame;
/* =========================
   SOUND & MUSIC SYSTEM
========================= */

// ---- SES AYARLARI ----
const soundSettings = {
  sfx: true,
  music: true,
  volume: 0.6
};

// ---- AUDIO CONTEXT ----
const AudioCtx = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioCtx();

// Basit beep √ºretici (dosya gerekmez)
function playBeep(freq=440, dur=0.08, type="sine", vol=0.5){
  if (!soundSettings.sfx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.value = freq;
  g.gain.value = vol * soundSettings.volume;
  o.connect(g).connect(audioCtx.destination);
  o.start();
  o.stop(audioCtx.currentTime + dur);
}

// ---- SFX BAƒûLANTILARI ----
const _meleeSfx = player.melee;
const _shootSfx = shootBullet;
shootBullet = function(){
  playBeep(820, 0.05, "square", 0.4);
  _shootSfx();
};

const _levelUpSfx = levelUp;
levelUp = function(){
  playBeep(520, 0.12, "sawtooth", 0.6);
  playBeep(780, 0.14, "sawtooth", 0.6);
  _levelUpSfx();
};

// D√º≈üman hasarƒ± i√ßin kƒ±sa klik
const _hitFlashSfx = hitFlash;
hitFlash = function(e){
  playBeep(220, 0.04, "triangle", 0.3);
  _hitFlashSfx(e);
};

// ---- ARKA PLAN M√úZƒ∞ƒûƒ∞ (LOOP) ----
let musicOsc = null;

function startMusic(){
  if (!soundSettings.music || musicOsc) return;
  musicOsc = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  musicOsc.type = "sine";
  musicOsc.frequency.value = 110;
  g.gain.value = 0.08 * soundSettings.volume;
  musicOsc.connect(g).connect(audioCtx.destination);
  musicOsc.start();
}

function stopMusic(){
  if (musicOsc){
    musicOsc.stop();
    musicOsc = null;
  }
}

// ƒ∞lk etkile≈üimde m√ºziƒüi ba≈ülat (tarayƒ±cƒ± kuralƒ±)
window.addEventListener("pointerdown", startMusic, { once:true });

// ---- AYAR MEN√úS√ú ----
const settingsBtn = document.createElement("button");
settingsBtn.textContent = "SETTINGS";
settingsBtn.style.cssText = `
  position:fixed; top:12px; left:12px;
  background:#0ff2; color:#eaf2ff;
  border:1px solid #0ff; padding:6px 10px;
`;
document.body.appendChild(settingsBtn);

const settingsPanel = document.createElement("div");
settingsPanel.style.cssText = `
  position:fixed; inset:30%;
  background:#02030a;
  border:2px solid #0ff;
  color:#eaf2ff;
  padding:12px;
  display:none;
`;
document.body.appendChild(settingsPanel);

settingsBtn.onclick = ()=>{
  settingsPanel.style.display = settingsPanel.style.display==="none"?"block":"none";
  renderSettings();
};

function renderSettings(){
  settingsPanel.innerHTML = `
    <h3>AYARLAR</h3>
    <label>
      <input type="checkbox" id="sfxChk" ${soundSettings.sfx?"checked":""}>
      Ses Efektleri
    </label><br><br>
    <label>
      <input type="checkbox" id="musicChk" ${soundSettings.music?"checked":""}>
      M√ºzik
    </label><br><br>
    <label>
      Ses Seviyesi
      <input type="range" id="volRange" min="0" max="1" step="0.05" value="${soundSettings.volume}">
    </label>
  `;

  document.getElementById("sfxChk").onchange = e=>{
    soundSettings.sfx = e.target.checked;
  };
  document.getElementById("musicChk").onchange = e=>{
    soundSettings.music = e.target.checked;
    if (soundSettings.music) startMusic();
    else stopMusic();
  };
  document.getElementById("volRange").oninput = e=>{
    soundSettings.volume = parseFloat(e.target.value);
  };
}
/* =========================
   BACKGROUND MUSIC FIX (REAL LOOP)
========================= */

// Ger√ßek m√ºzik objesi
let bgMusic = new Audio();
bgMusic.loop = true;
bgMusic.volume = 0.4 * soundSettings.volume;

// Telifsiz, data-uri synth m√ºzik (harici dosya gerekmez)
bgMusic.src = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA=";

// ƒ∞lk kullanƒ±cƒ± etkile≈üiminde ba≈ülat
function tryStartMusic(){
  if (!soundSettings.music) return;
  bgMusic.volume = 0.4 * soundSettings.volume;
  bgMusic.play().catch(()=>{});
}

// Her tƒ±klama/dokunu≈üta dene (1 kere √ßalƒ±nca bƒ±rakƒ±r)
window.addEventListener("pointerdown", tryStartMusic);
window.addEventListener("keydown", tryStartMusic);

// Ayarlardan kontrol
const _musicToggleFix = renderSettings;
renderSettings = function(){
  _musicToggleFix();

  const musicChk = document.getElementById("musicChk");
  if (musicChk){
    musicChk.onchange = e=>{
      soundSettings.music = e.target.checked;
      if (soundSettings.music) tryStartMusic();
      else bgMusic.pause();
    };
  }

  const volRange = document.getElementById("volRange");
  if (volRange){
    volRange.oninput = e=>{
      soundSettings.volume = parseFloat(e.target.value);
      bgMusic.volume = 0.4 * soundSettings.volume;
    };
  }
};
/* =========================
   ROBLOX STYLE LEADERBOARD
========================= */

const leaderboardWrapper = document.createElement("div");
leaderboardWrapper.style.cssText = `
  position:fixed;
  right:10px;
  bottom:10px;
  width:260px;
  max-height:320px;
  background:#000;
  border:1px solid #0ff;
  color:#0ff;
  font-size:12px;
  display:flex;
  flex-direction:column;
  transition:transform 0.35s ease;
  box-shadow:0 0 15px #0ff;
  z-index:9999;
`;

document.body.appendChild(leaderboardWrapper);

// HEADER
const lbHeader = document.createElement("div");
lbHeader.style.cssText = `
  padding:6px;
  background:#001f1f;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
`;
lbHeader.innerHTML = `<b>üèÜ LEADERBOARD</b><span id="lbToggle">‚¨Ü</span>`;
leaderboardWrapper.appendChild(lbHeader);

// CONTENT (SCROLLABLE)
const lbContent = document.createElement("div");
lbContent.style.cssText = `
  overflow-y:auto;
  flex:1;
  padding:6px;
`;
leaderboardWrapper.appendChild(lbContent);

// Toggle logic
let lbClosed = false;

lbHeader.onclick = () => {
  lbClosed = !lbClosed;

  if (lbClosed) {
    leaderboardWrapper.style.transform = "translateY(280px)";
    document.getElementById("lbToggle").textContent = "‚¨á";
  } else {
    leaderboardWrapper.style.transform = "translateY(0px)";
    document.getElementById("lbToggle").textContent = "‚¨Ü";
  }
};
  
import("https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js")
.then(appModule => {

import("https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js")
.then(dbModule => {

  const { initializeApp, getApp } = appModule;
  const { getDatabase, ref, set, onValue } = dbModule;

  firebaseApp = initializeApp(firebaseConfig);
  firebaseDB = getDatabase(firebaseApp);
  window.firebaseAppReady = true;
  
  let playerName = localStorage.getItem("playerName");
  if (!playerName) {
    playerName = prompt("ƒ∞smini gir:");
    localStorage.setItem("playerName", playerName);
  }

  function submitScore() {
    onValue(ref(db, "leaderboard"), snapshot => {
      level: player.level,
      coins: player.coins,
      timestamp: Date.now()
    });
  }

  setInterval(submitScore, 30000);

  onValue(ref(database, "leaderboard"), snapshot => {
    if(!window.firebaseDB) return;
    const db = firebaseDB;


    const data = snapshot.val();
    if (!data) return;

    const arr = Object.entries(data)
      .sort((a,b) => b[1].level - a[1].level);

    lbContent.innerHTML = "";

    arr.forEach((p,i) => {

      let color = "#0ff";
      if (i === 0) color = "#ffd700";
      else if (i === 1) color = "#c0c0c0";
      else if (i === 2) color = "#cd7f32";

      lbContent.innerHTML += `
        <div style="
          padding:4px;
          border-bottom:1px solid #022;
          color:${color};
        ">
          ${i+1}. ${p[0]} - Lv ${p[1].level}
        </div>
      `;
    });

  });

});
});

/* =========================
   PVP SYSTEM (SECURE TRANSACTION)
========================= */

import("https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js").then(dbModule => {

const { getDatabase, ref, runTransaction } = dbModule;

if(!window.firebaseAppReady) return;
const db = firebaseDB;
if (!window.playerId) return;
const ROOM = "world1";

// PvP kontrol (melee alanƒ±nda)
function checkPvP() {
  Object.entries(remotePlayers).forEach(([id, rp]) => {
    const dist = Math.hypot(player.x - rp.x, player.y - rp.y);

    if (dist < 40 && attackInput.melee) {
      stealLevel(id);
    }
  });
}

// G√ºvenli level √ßalma
function stealLevel(targetId) {
  const targetRef = ref(db, "rooms/"+ROOM+"/players/"+targetId);

  runTransaction(targetRef, currentData => {
    if (currentData == null) return;

    if (currentData.level > 1) {
      const stolen = currentData.level;
      currentData.level = 1;

      // kazanana level ekle
      player.level += stolen;

      // kendi levelini DB'ye yaz
      const myRef = ref(db, "rooms/"+ROOM+"/players/"+playerId);
      runTransaction(myRef, myData => {
        if (!myData) return;
        myData.level = player.level;
        return myData;
      });

      return currentData;
    }

    return currentData;
  });
}

// Update zincirine baƒüla
const _updatePvP = update;
update = function(dt){
  _updatePvP(dt);
  checkPvP();
};

});

/* =========================
   MINI BOSS SYSTEM
========================= */

function spawnMiniBoss(){
  enemies.push({
   type: ENEMY_TYPES.BOSS,
    x: player.x + 300,
    y: player.y,
    size: 40,
    speed: 60,
    maxHealth: 500,
    health: 500
  });
}

setInterval(()=>{
  if (player.level > 0 && player.level % 10 === 0 && enemies.filter(e=>e.type===ENEMY_TYPES.BOSS).length===0){
    spawnMiniBoss();
  }
}, 15000);
/* =========================
   SKIN DROP + WARDROBE
========================= */

player.inventory = [];
player.equippedSkin = null;

function dropSkin(){
  const skin = "skin_" + Math.floor(Math.random()*1000);
  player.inventory.push(skin);
}
/* =========================
   WARDROBE (FIXED VERSION)
========================= */

player.inventory = player.inventory || [];
player.equippedSkin = player.equippedSkin || null;

let wardrobePanel = null;

// BUTONU √ñNCE OLU≈ûTUR
const wardrobeBtn = document.createElement("button");
wardrobeBtn.textContent = "DOLAP";
wardrobeBtn.style.position = "fixed";
wardrobeBtn.style.left = "12px";
wardrobeBtn.style.top = "120px";
wardrobeBtn.style.zIndex = "9999";
document.body.appendChild(wardrobeBtn);

// TOGGLE FONKSƒ∞YON
function toggleWardrobe(){

  // A√ßƒ±ksa kapat
  if (wardrobePanel){
    wardrobePanel.remove();
    wardrobePanel = null;
    return;
  }

  // Panel olu≈ütur
  wardrobePanel = document.createElement("div");
  wardrobePanel.style.cssText = `
    position:fixed;
    inset:20%;
    background:#000;
    color:#0ff;
    border:2px solid #0ff;
    padding:20px;
    overflow:auto;
    z-index:9999;
  `;

  wardrobePanel.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3>DOLAP</h3>
      <button id="closeWardrobe">‚úï</button>
    </div>
    <hr>
  `;

  // Skin listele
  if (player.inventory.length === 0){
    wardrobePanel.innerHTML += "<div>Envanter bo≈ü</div>";
  }

    Array.from(player.inventory).forEach(s=>{
    const b = document.createElement("button");
    b.textContent = s + (player.equippedSkin === s ? " (TAKILI)" : "");
    b.style.display="block";
    b.style.marginBottom="6px";

    b.onclick = ()=> {
      player.equippedSkin = s;
      toggleWardrobe();   // kapanƒ±p tekrar a√ßarak refresh
      toggleWardrobe();
    };

    wardrobePanel.appendChild(b);
  });

  document.body.appendChild(wardrobePanel);

  // X butonu
  document.getElementById("closeWardrobe").onclick = ()=>{
    wardrobePanel.remove();
    wardrobePanel = null;
  };
}

// TIKLAMA BAƒûLA
wardrobeBtn.onclick = toggleWardrobe;

/* =========================
   MAIN MENU ROOM SYSTEM + RESPAWN
========================= */

import("https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js").then(dbModule=>{

const { getDatabase, ref, set, get, remove, onDisconnect, onValue } = dbModule;
const db = firebaseDB;

let currentRoom = null;
let myPlayerRef = null;
let myPlayerId = localStorage.getItem("playerName") || 
                 "p_"+Math.random().toString(36).substr(2,9);

localStorage.setItem("playerName", myPlayerId);

/* ---------- ODA OLU≈ûTUR ---------- */

document.getElementById("createRoomBtn").onclick = async () => {

  const roomName = "room_" + Math.random().toString(36).substr(2,5);

  // Respawn noktasƒ± olu≈ütur
  await set(ref(db, `rooms/${roomName}/meta`), {
    respawn: {
      x: 0,
      y: 0
    }
  });

  joinRoom(roomName);
  mainMenu.style.display="none";
};

/* ---------- ODAYA Gƒ∞R ---------- */

document.getElementById("joinRoomBtn").onclick = async () => {

  const roomsSnap = await get(ref(db, "rooms"));
  const rooms = roomsSnap.val() || {};

  for (const roomName in rooms) {

    const players = rooms[roomName].players || {};
    const count = Object.keys(players).length;

    if (count < 10) {
      joinRoom(roomName);
      mainMenu.style.display="none";
      return;
    }
  }

  alert("Bo≈ü oda yok!");
};

/* ---------- ODAYA KATIL ---------- */

async function joinRoom(roomName){

  if (myPlayerRef){
    remove(myPlayerRef);
  }

  currentRoom = roomName;

  const roomMeta = await get(ref(db, `rooms/${roomName}/meta`));
  const respawn = roomMeta.val()?.respawn || {x:0,y:0};

  // Respawn konumuna ƒ±≈üƒ±nla
  player.x = respawn.x;
  player.y = respawn.y;

  myPlayerRef = ref(db, `rooms/${roomName}/players/${myPlayerId}`);

  await set(myPlayerRef, {
    x: player.x,
    y: player.y,
    level: player.level,
    hp: player.health
  });

  onDisconnect(myPlayerRef).remove();

  // Pozisyon sync
  setInterval(()=>{
    if (!currentRoom) return;
    set(myPlayerRef,{
      x: player.x,
      y: player.y,
      level: player.level,
      hp: player.health
    });
  }, 120);

  // Remote players
  onValue(ref(db, `rooms/${roomName}/players`), snapshot=>{
    const data = snapshot.val() || {};
    Object.keys(remotePlayers).forEach(id=>delete remotePlayers[id]);

    Object.entries(data).forEach(([id,p])=>{
      if (id === myPlayerId) return;
      remotePlayers[id] = p;
    });
  });

}

/* ---------- √ñL√úNCE RESPAWN ---------- */

const _updateRespawn = update;
update = function(dt){
  _updateRespawn(dt);

  if (player.health <= 0 && currentRoom){

    get(ref(db, `rooms/${currentRoom}/meta`)).then(snap=>{
      const respawn = snap.val()?.respawn || {x:0,y:0};
      player.x = respawn.x;
      player.y = respawn.y;
    });

    player.level = 1;
    player.health = player.maxHealth;
  }
};

});
/* =========================
   ROOM CHAT SYSTEM
========================= */

import("https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js").then(dbModule=>{

const { getDatabase, ref, push, onValue } = dbModule;const db = firebaseDB;


let chatRoom = null;

// Chat UI
const chatBox = document.createElement("div");
chatBox.style.cssText = `
  position:fixed;
  bottom:10px;
  right:10px;
  width:260px;
  height:200px;
  background:#000;
  color:#0ff;
  border:1px solid #0ff;
  display:flex;
  flex-direction:column;
  font-size:12px;
`;
document.body.appendChild(chatBox);

const chatMessages = document.createElement("div");
chatMessages.style.flex="1";
chatMessages.style.overflow="auto";
chatBox.appendChild(chatMessages);

const chatInput = document.createElement("input");
chatInput.placeholder="Mesaj yaz...";
chatInput.style.background="#111";
chatInput.style.color="#0ff";
chatBox.appendChild(chatInput);

chatInput.addEventListener("keydown", e=>{
  if (e.key === "Enter" && currentRoom){
    push(ref(db, `rooms/${currentRoom}/chat`), {
     user: window.playerId || myPlayerId,
      msg: chatInput.value,
      time: Date.now()
    });
    chatInput.value="";
  }
});

// Odaya girince chat dinle
function attachChat(roomName){
  onValue(ref(db, `rooms/${roomName}/chat`), snap=>{
    const data = snap.val() || {};
    chatMessages.innerHTML="";
    Object.values(data).slice(-20).forEach(m=>{
      chatMessages.innerHTML += `<div><b>${m.user}:</b> ${m.msg}</div>`;
    });
    chatMessages.scrollTop = chatMessages.scrollHeight;
  });
}

// joinRoom override
const _joinRoomChat = joinRoom;
joinRoom = function(roomName){
  _joinRoomChat(roomName);
  chatRoom = roomName;
  attachChat(roomName);
};

});
/* =========================
   RESPAWN PROTECTION
========================= */

player.spawnShield = 0;

const _updateShield = update;
update = function(dt){
  _updateShield(dt);

  if (player.spawnShield > 0){
    player.spawnShield -= dt;
  }
};

// Respawn sƒ±rasƒ±nda kalkan ver
if (typeof joinRoom === "function"){
  const _respawnFix = joinRoom;
  joinRoom = function(roomName){
    _respawnFix(roomName);
    player.spawnShield = 3;
  };
}
/* =========================
   BOSS SPAWN CONDITION
========================= */

setInterval(()=>{
  if (!currentRoom) return;

  const playerCount = Object.keys(remotePlayers).length + 1;

  if (playerCount >= 3){
    spawnMiniBoss();
  }

}, 20000);
/* =========================
   RANK SYSTEM
========================= */

function getRank(level){
  if (level >= 81) return "NEON GOD";
  if (level >= 51) return "DIAMOND";
  if (level >= 26) return "GOLD";
  if (level >= 11) return "SILVER";
  return "BRONZE";
}

// Rank HUD
const rankHUD = document.createElement("div");
rankHUD.style.cssText = `
  position:fixed;
  top:60px;
  left:12px;
  color:#0ff;
  font-weight:bold;
`;
document.body.appendChild(rankHUD);

// Rank g√ºncelle
const _updateRank = update;
update = function(dt){
  _updateRank(dt);

  // RANK HUD
  rankHUD.textContent = "RANK: " + getRank(player.level);

  // DASH COOLDOWN
  if(player.dash.cooldown > 0){
    player.dash.cooldown -= dt;
  }

  // DASH TETƒ∞KLEME
  if(attackInput.dash){
    performDash();
    attackInput.dash = false;
  }
};

/* =========================
   CLAN SYSTEM
========================= */

import("https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js").then(dbModule=>{

const { getDatabase, ref, set, get, update } = dbModule;
const db = firebaseDB;

player.clan = null;

// Clan UI
const clanBtn = document.createElement("button");
clanBtn.textContent = "CLAN";
clanBtn.style.cssText = `
  position:fixed;
  top:120px;
  left:12px;
`;
document.body.appendChild(clanBtn);

const clanPanel = document.createElement("div");
clanPanel.style.cssText = `
  position:fixed;
  inset:30%;
  background:#000;
  color:#0ff;
  border:2px solid #0ff;
  padding:20px;
  display:none;
`;
document.body.appendChild(clanPanel);

clanBtn.onclick = ()=>{
  clanPanel.style.display = clanPanel.style.display==="none"?"block":"none";
  renderClan();
};

function renderClan(){
  clanPanel.innerHTML = `
    <h2>CLAN</h2>
    <input id="clanNameInput" placeholder="Clan adƒ±">
    <button id="createClan">Olu≈ütur</button>
    <button id="joinClan">Katƒ±l</button>
    <hr>
    <div>Mevcut Clan: ${player.clan || "Yok"}</div>
  `;

  document.getElementById("createClan").onclick = async ()=>{
    const name = document.getElementById("clanNameInput").value;
    if (!name) return;

    await set(ref(db, "clans/"+name+"/members/"+myPlayerId), true);
    player.clan = name;
    update(ref(db, "players/"+myPlayerId), { clan:name });
    renderClan();
  };

  document.getElementById("joinClan").onclick = async ()=>{
    const name = document.getElementById("clanNameInput").value;
    if (!name) return;

    const snap = await get(ref(db, "clans/"+name));
    if (!snap.exists()){
      alert("Clan yok!");
      return;
    }

    await set(ref(db, "clans/"+name+"/members/"+myPlayerId), true);
    player.clan = name;
    update(ref(db, "players/"+myPlayerId), { clan:name });
    renderClan();
  };
}

});
/* =========================
   CLAN TAG DISPLAY
========================= */

const _drawClan = draw;
draw = function(){
  _drawClan();

  ctx.save();
  ctx.translate(canvas.width/2 - player.x, canvas.height/2 - player.y);

  ctx.fillStyle = "#fff";
  ctx.font = "12px Arial";
  const tag = player.clan ? "["+player.clan+"] " : "";
  ctx.fillText(tag + myPlayerId, player.x-20, player.y-25);

  ctx.restore();
};


document.getElementById("sfxToggle").onchange = e=>{
  soundSettings.sfx = e.target.checked;
};

document.getElementById("musicToggle").onchange = e=>{
  soundSettings.music = e.target.checked;
  if(soundSettings.music) tryStartMusic();
  else bgMusic.pause();
};

document.getElementById("volumeSlider").oninput = e=>{
  soundSettings.volume = parseFloat(e.target.value);
  bgMusic.volume = 0.4 * soundSettings.volume;
};

</script>
</body>
</html>
